<link rel="import" href="../polymer/polymer.html">

<!-- App -->
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-route/app-location.html">

<!-- Elfy -->
<link rel="import" href="../elfy-api/elfy-api.html">
<link rel="import" href="../js-data-behaviors/js-data-collection-behavior.html">
<link rel="import" href="../js-data-behaviors/js-data-record-behavior.html">
<link rel="import" href="../ee-helper-behavior/ee-helper-behavior.html">

<!-- Iron -->

<!-- Paper -->
<link rel="import" href="../paper-toast/paper-toast.html">

<!-- Third -->

<!-- My -->
<link rel="import" href="ee-chat-view.html">
<link rel="import" href="ee-chat-settings.html">
<!--
`ee-chat`


@demo demo/index.html
-->

<dom-module id="ee-chat">
  <template>
    <style is="custom-style" include="shared-styles">

      .bubble-view {
        display: none;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        position: fixed;
        bottom: 10px;
        z-index: 999;
        width: 320px;
        height: 400px;
        background: #fafafa;
        right: 24px;

        --ee-chat-view-header: {
          display: block;
          background: #0ea7ee;
          height: 36px;
        };
      }

      @media(max-width:600px) {
        .bubble-view {
          bottom: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
        }
      }
    </style>

    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route route="{{route}}"></app-route>

    <ee-chat-settings
      visit-id="[[visitId]]"
      pubnub-token="{{pubnubToken}}"
      pubnub-publish-key="{{pubnubPublishKey}}"
      pubnub-subscribe-key="{{pubnubSubscribeKey}}"
      cipher-key="{{cipherKey}}">
    </ee-chat-settings>

    <ee-chat-view id="view" class$="[[_ifThenElse(asBubble, 'bubble-view', '')]]"
      messages="[[messages]]"
      on-send-message="_sendMessage"
      disabled="[[disabled]]"
      on-close-tapped="hideChat"
      me-id="[[me.id]]"
      header-title="[[headerTitle]]">
    </ee-chat-view>

  </template>
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.2.5.js"></script>
  <script>
    Polymer({

      is: 'ee-chat',

      behaviors: [
        Elfy.JSDataCollectionBehavior,
        Elfy.JSDataRecordBehavior,
        Elfy.EEHelperBehavior,
      ],

      recordName: 'message',

      properties: {

        asBubble: {
          type: Boolean,
          value: false,
        },

        active: {
          type: Boolean,
          value: false,
        },

        headerTitle: {
          type: String,
          value: '',
        },

        route: {
          type: Object,
          value() { return {} },
        },

        toastLinkBasePath: {
          type: String,
          value: '/dashboard/visits/'
        },

        toastLinkTitle: {
          type: String,
          value: 'To visit'
        },

        toastDuration: {
          type: Number,
          value: 5000
        },

        me: {
          type: Object,
          value() { return {} },
        },

        profile: {
          type: Object,
          value() { return {} },
        },

        /* If true, the chat input and send button are disabled. */
        disabled: {
          type: Boolean,
          value: false,
          notify: true
        },

        visitId: {
          type: Number,
        },

        message: {
          type: Object,
          value() { return {} },
        },

        messages: {
          type: Array,
          value() { return [] },
          notify: true
        },

        pubnubPublishKey: {
          type: String,
        },

        pubnubSubscribeKey: {
          type: String,
        },

        pubnubToken: {
          type: String,
        },

        cipherKey: {
          type: String,
        },

        _pubnub: Object,

      },

      observers: [
        '_computeRequest(active,visitId)',
        '_initPubnub(active,pubnubToken,pubnubSubscribeKey,pubnubPublishKey,cipherKey,visitId)'
      ],

      hideChat() {
        this.$.view.classList.add('hidden')
      },

      showChat() {
        this.$.view.classList.remove('hidden')
      },

      _initPubnub(active,pubnubToken,pubnubSubscribeKey,pubnubPublishKey,cipherKey,visitId) {
        if (!pubnubToken || !pubnubSubscribeKey || !pubnubPublishKey || !cipherKey || !visitId) return
        var self = this

        if (this._pubnub) {
          this._pubnub.unsubscribeAll();
        }

        this._pubnub = new PubNub({
          publishKey : pubnubPublishKey,
          subscribeKey : pubnubSubscribeKey,
          authKey: pubnubToken,
          cipherKey: cipherKey
        })

        this._pubnub.addListener({
          message: function(message) {
            self._messageReceived(message)
          },
        })

        this._pubnub.subscribe({
          channels: [self.visitId.toString()]
        });
      },

      _computeRequest(active,visitId) {
        if (!active) return
        this.messages = []
        if (!visitId) return
        this.JSData.noNotify = true
        this._loadFreshData(App.Message, 'messages', {'visitId': visitId})
      },

      _sendMessage(e) {
        if (!this._pubnub) {
          this._initPubnub(
            this.active,
            this.pubnubToken,
            this.pubnubSubscribeKey,
            this.pubnubPublishKey,
            this.cipherKey
          )
          return
        }
        this.disabled = true

        var m = App.Message.createRecord()
        m.message = {}
        m.message.text = e.detail
        m.visitId = this.visitId
        m.userId = this.me.id
        this.message = m

        this._publishMessage(m)
        this._postMessage(m)
      },

      _postMessage(m) {
        this._save()
      },

      _publishMessage(message) {
        var self = this

        try {
          message.senderFirstName = this.profile.firstName
          message.senderLastName  = this.profile.lastName.charAt(0) + '.'
        } catch (e) {
          message.senderLastName = message.senderFirstName = ''
        }

        try {
          message.senderAvatar = this.profile.avatar
        } catch (e) {
          message.senderAvatar = ''
        }

        this._pubnub.publish({
            channel : self.visitId.toString(),
            message : message,
            callback : function(m){
                console.log(m)
            }
        },
        function (status, response) {
            if (status.error) {
                // handle error
                console.log(status)
                self._loadData()
            } else {
                console.log("message Published w/ timetoken", response.timetoken)
            }
        })
      },

      _messageReceived(m) {
        if (m.message && m.message.userId && m.message.userId !== this.me.id) {
          this._showToast(m)
          this._playSound()
        }
        this.push('messages', m.message)
      },

      _showToast(m) {
        if (this.active) return
        var app = document.querySelector('app-element')
        if (app) {
          var toast = app.$.chatToast
          if (toast) {
            toast.text = m.message.senderFirstName + ' wrote: ' + m.message.message.text
            toast.dataArgs = m.channel
            toast.show()
          } else {
            console.warn('no toast found - chatToast in app-element')
          }
        } else {
          console.warn('app-element not found to query toast')
        }
      },

      _playSound() {
        if (this.active) return
        var snd = new Audio("./newMessage.mp3"); // buffers automatically when created
        snd.play();
      },

      _toVisit(e) {
        var visitId = e.currentTarget.parentElement.dataArgs
        this.set('route.path', this.toastLinkBasePath + visitId + '/?chat=true')
      },

      _respondedWithError(error) {
        this._loadData()
      },

      _collectionLoaded() {
        this.disabled = false
      },

      _recordCreated() {
        this.disabled = false
      },

    });
  </script>
</dom-module>
